repeat task.wait() until game:IsLoaded()

-- [LOADING SCREEN]
loadstring(game:HttpGet("https://raw.githubusercontent.com/ANHub-Script/ANUI/refs/heads/main/dist/loading2.lua"))()

-- [SERVICES]
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TextChatService = game:GetService("TextChatService")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService('VirtualUser')

-- [VARS & CHARACTER]
local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")
local humanoid = character:WaitForChild("Humanoid")

LocalPlayer.CharacterAdded:Connect(function(newChar)
    character = newChar
    hrp = newChar:WaitForChild("HumanoidRootPart")
    humanoid = newChar:WaitForChild("Humanoid")
end)

-- Anti-AFK
LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- [CONFIG PATHS]
local FolderPath = "ANUI/AnimeAdvanced"
local ConfigPath = FolderPath .. "/config"
local SelectionsFile = FolderPath .. "/MapSelections.json" -- File Save Target Per-Map
local ConfigName = "AN_AnimeAdvanced"

if not isfolder("ANUI") then makefolder("ANUI") end
if not isfolder(FolderPath) then makefolder(FolderPath) end
if not isfolder(ConfigPath) then makefolder(ConfigPath) end

-- [DATA SYSTEM: MAP SELECTION]
local MapSelections = {}
local isUpdatingUI = false 
local isTransitioning = false 

-- Load Data Map Selections
if isfile(SelectionsFile) then
    local success, result = pcall(function() return HttpService:JSONDecode(readfile(SelectionsFile)) end)
    if success and type(result) == "table" then MapSelections = result end
end

local function SaveMapSelection(mapName, enemyValue)
    if not mapName or isUpdatingUI or isTransitioning then return end
    MapSelections[mapName] = enemyValue
    writefile(SelectionsFile, HttpService:JSONEncode(MapSelections))
end

-- [HELPER: KEYS]
local function GetOnlineKeys()
    local keys = {"Keynya", "FreeKey"}
    local url = "https://raw.githubusercontent.com/AdityaNugrahaInside/ANHub/refs/heads/main/Key"
    local success, response = pcall(function() return game:HttpGet(url) end)
    if success then
        keys = {}
        for line in response:gmatch("[^\r\n]+") do
            local cleanKey = string.gsub(line, "^%s*(.-)%s*$", "%1")
            if cleanKey ~= "" then table.insert(keys, cleanKey) end
        end
    end
    return keys
end

-- [HELPER: DATA SCAN]
-- Fungsi ini hanya sebagai backup jika BridgeNet belum mengirim data
local function ScanPlayerData()
    local oldData = getgenv().PlayerData
    -- Jangan hapus nil secara paksa jika kita sudah punya data dari BridgeNet agar tidak flicker
    if not getgenv().PlayerData then
        local candidates = {}
        for _, v in pairs(getgc(true)) do
            if type(v) == "table" then
                if oldData and v == oldData then continue end
                if rawget(v, "Map") and rawget(v, "Coins") and rawget(v, "Stats") then
                    if v.Map ~= nil then table.insert(candidates, v) end
                end
            end
        end
        if #candidates > 0 then getgenv().PlayerData = candidates[#candidates] end
    end
end
task.spawn(ScanPlayerData)

-- [UI LIBRARY]
local l = loadstring(game:HttpGet("https://raw.githubusercontent.com/ANHub-Script/ANUI/refs/heads/main/dist/main.lua"))()
local Window = l:CreateWindow({
    Title = "AN Hub - Anime Advanced",
    Icon = "rbxassetid://84366761557806",
    Author = "Aditya Nugraha",
    Folder = "AnimeAdvanced",
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true,
    Theme = "Dark",
    Resizable = true,
    SideBarWidth = 220,
    HideSearchBar = true,
    ToggleKey = Enum.KeyCode.RightControl,
    KeySystem = {
        Enabled = true,
        Title = "ANHub Access",
        Description = "Key expires every 24 Hours!",
        Key = GetOnlineKeys(),
        URL = "https://discord.gg/cy6uMRmeZ",
        Note = "Join Discord for Key",
        SaveKey = true
    }
})

-- Sidebar Animation
task.delay(1.0, function() Window:CollapseSidebar() end)
task.delay(3.0, function() Window:ExpandSidebar() end)

local function Notify(title, content, icon)
    if l then l:Notify({ Title = title, Content = content, Icon = icon, Duration = 3 }) end
end

-- ============================================================================
--  GAME LOGIC VARIABLES
-- ============================================================================
local attackRangePart 
local distance = 10000
local attackRange 

-- Farm Vars
local targetList = {}
local nameList = {} 
local isFarm1 = false

-- Boss Vars
local GlobalBossDB = {} -- Dynamic from Module
local selectedBosses = {}
local isAutoBoss = false 
local isGlobalBossActive = false 
local savedPreviousMap = nil

-- Dungeon/Trial Vars
local waveTrial = 0
local targetWaveTrial = 500
local trialList = {{name = "TrialEasy", time = 15}}
local isTrial = false

-- Raid Vars (NEW)
local waveRaid = 0
local targetWaveRaid = 50
local isRaid = false
local raidJoinList = {{name = "Raid", time = 45}} -- Sesuaikan waktu jika perlu, default disamakan logicnya

-- Powers
local powerList = {
    {name = "Hero Rank", auto = false},
    {name = "Ninja Rank", auto = false},
    {name = "Haki", auto = false},
    {name = "Passive", auto = false},
    {name = "Clan", auto = false}
}

-- Stronger
local isAutoClaimExpedition = false
local targetStar = "None"
local expeditionTarget = "None"
local isRankUp = false

-- Range Checker
task.spawn(function()
    while not Window.Destroyed do
        attackRangePart = workspace:FindFirstChild("Cache") and workspace.Cache:FindFirstChild("Area")
        if attackRangePart then attackRange = attackRangePart.Size.X/2 end
        task.wait(1)
    end
end)

local function getPosition(obj)
    if obj:IsA("Model") then return obj:GetPivot().Position
    elseif obj:IsA("BasePart") then return obj.Position end
    return nil
end

local function getDistance(obj1, obj2)
    local pos1 = getPosition(obj1)
    local pos2 = getPosition(obj2)
    if pos1 and pos2 then return (pos1 - pos2).Magnitude end
    return 999999
end

-- ============================================================================
--  DATA LOADER & HELPERS
-- ============================================================================
local CharacterIcons = {}
local GlobalItemDB = {}
local GlobalAvatarDB = {}
local GlobalSwordDB = {} 
local GlobalRankDB = {}

-- Helper: Parse Number Suffix
local function ParseAbbreviated(str)
    if type(str) ~= "string" then return 0 end
    local num = tonumber(string.match(str, "^[%d%.]+")) or 0
    local suffix = string.match(str, "[%a]+$")
    local mult = 1
    if suffix == "K" then mult = 1e3
    elseif suffix == "M" then mult = 1e6
    elseif suffix == "B" then mult = 1e9
    elseif suffix == "T" then mult = 1e12
    elseif suffix == "Qd" then mult = 1e15
    elseif suffix == "Qn" then mult = 1e18
    end
    return num * mult
end

-- Helper: Format Number
local function FormatNumber(n)
    if n >= 1e18 then return string.format("%.2fQn", n/1e18)
    elseif n >= 1e15 then return string.format("%.2fQd", n/1e15)
    elseif n >= 1e12 then return string.format("%.2fT", n/1e12)
    elseif n >= 1e9 then return string.format("%.2fB", n/1e9)
    elseif n >= 1e6 then return string.format("%.2fM", n/1e6)
    elseif n >= 1e3 then return string.format("%.2fK", n/1e3)
    else return tostring(n) end
end

local function LoadGameData()
    -- Load Global Bosses
    local successBoss, resultBoss = pcall(function() return require(ReplicatedStorage.Shared.Enemies["Global Bosses"]) end)
    if successBoss and type(resultBoss) == "table" then
        for bossName, data in pairs(resultBoss) do
            if data.Map then GlobalBossDB[bossName] = data end 
        end
    end

    -- Load Ranks
    local successRanks, resultRanks = pcall(function() return require(ReplicatedStorage.Shared.Ranks) end)
    if successRanks and type(resultRanks) == "table" then
        GlobalRankDB = resultRanks
    end

    -- Load Other DBs
    local s1, r1 = pcall(function() return require(ReplicatedStorage.Shared.CharacterIcons) end)
    if s1 then CharacterIcons = r1 end
    local s2, r2 = pcall(function() return require(ReplicatedStorage.Shared.Items) end)
    if s2 then GlobalItemDB = r2 end
    local s3, r3 = pcall(function() return require(ReplicatedStorage.Shared.Avatars) end)
    if s3 then GlobalAvatarDB = r3 end
    local s4, r4 = pcall(function() return require(ReplicatedStorage.Shared.Swords) end)
    if s4 then GlobalSwordDB = r4 end
end
LoadGameData()

-- ============================================================================
--  ENEMY LIST & AUTO SELECT (FARMING)
-- ============================================================================
local UI = {} 
local DifficultyRank = {["Very Easy"]=1, ["Easy"]=2, ["Medium"]=3, ["Hard"]=4, ["Insane"]=5, ["Boss"]=6, ["Godlike"]=7}

local function resetEnemiesList()
    isUpdatingUI = true
    
    if not getgenv().PlayerData or not getgenv().PlayerData.Map then ScanPlayerData() end
    local PlayerData = getgenv().PlayerData
    if PlayerData and PlayerData.Map == nil then
        ScanPlayerData()
        PlayerData = getgenv().PlayerData
    end

    local currentNames = {}
    local nameSet = {}
    local CurrentMapName = "Unknown"

    if PlayerData and PlayerData.Map then
        CurrentMapName = PlayerData.Map
        local success, AllEnemiesDB = pcall(function() return require(game:GetService("ReplicatedStorage").Shared.Enemies) end)

        if success and AllEnemiesDB and AllEnemiesDB[CurrentMapName] then
            local MapEnemies = AllEnemiesDB[CurrentMapName]
            for enemyName, enemyData in pairs(MapEnemies) do
                if type(enemyName) == "string" and enemyName ~= "" and not nameSet[enemyName] then
                    nameSet[enemyName] = true
                    local diff = enemyData.Difficult or "Unknown"
                    local hp = enemyData.Health or "?"
                    local rank = DifficultyRank[diff] or 99
                    
                    local iconAsset = CharacterIcons[enemyName] or nil
                    local processedDrops = {}
                    if enemyData.Drops then processedDrops = table.clone(enemyData.Drops) end
                    local dropIcons = {}

                    for _, drop in ipairs(processedDrops) do
                        if drop.Item then
                            local iconFound = nil
                            if drop.Type == "Avatar" then
                                local avatarData = GlobalAvatarDB[drop.Item]
                                if avatarData then iconFound = avatarData.Icon end
                            elseif drop.Type == "Sword" then
                                local swordData = GlobalSwordDB[drop.Item]
                                if swordData then iconFound = swordData.Icon end
                            else
                                local itemData = GlobalItemDB[drop.Item]
                                if itemData then iconFound = itemData.Icon end
                            end
                            if iconFound then table.insert(dropIcons, iconFound) end
                        end
                    end

                    local descStr = "HP: " .. tostring(hp)
                    table.insert(currentNames, {
                        Title = enemyName .. " [" .. diff .. "]",
                        Desc = descStr,
                        Value = enemyName, 
                        Rank = rank,
                        Icon = iconAsset,
                        Images = dropIcons 
                    })
                end
            end
        else
            ScanPlayerData() 
        end
        
        table.sort(currentNames, function(a, b)
            if a.Rank == b.Rank then return a.Value < b.Value end
            return a.Rank < b.Rank 
        end)
        
        table.clear(nameList)
        for _, v in ipairs(currentNames) do table.insert(nameList, v) end
        
        if UI.EnemyDD then
            pcall(function() UI.EnemyDD:Refresh(nameList) end)
            local savedEnemy = MapSelections[CurrentMapName]
            local foundItem = nil
            if savedEnemy then
                for _, item in ipairs(nameList) do if item.Value == savedEnemy then foundItem = item break end end
            end
            if foundItem then
                UI.EnemyDD:Select(foundItem)
                table.clear(targetList)
                table.insert(targetList, foundItem.Value)
                Notify("System", "Auto-Selected: " .. foundItem.Value, "check")
            else
                UI.EnemyDD:Select(nil)
                table.clear(targetList)
            end
        end
    end
    task.wait(0.2)
    isUpdatingUI = false
end

-- ============================================================================
--  BRIDGENET & TELEPORT SYSTEM
-- ============================================================================
local function SmartTeleport(mapName)
    if not mapName or mapName == "None" then return end
    if getgenv().PlayerData and getgenv().PlayerData.Map == mapName then return end

    isTransitioning = true
    ReplicatedStorage.BridgeNet2.dataRemoteEvent:FireServer({{"Player", "Teleport", "Teleport", mapName, n = 4}, "\2"})
    
    repeat task.wait(0.5) until not isTransitioning
    task.wait(1.5) 
end

ReplicatedStorage.BridgeNet2.dataRemoteEvent.OnClientEvent:Connect(function(data)
    local events = data["\2"]
    if not events then return end
    for _, event in ipairs(events) do
        if event[1] == "General" and event[2] == "Transition" and event[3] == "Teleport" then isTransitioning = true end
        if event[1] == "Player" and event[2] == "Data" and event[3] == "MassUpdate" then
            local uData = event[4]
            if uData then
                if uData.Power then
                    if not getgenv().PlayerData then getgenv().PlayerData = {} end
                    getgenv().PlayerData.Power = uData.Power
                end
                
                if uData.Rank then
                    if not getgenv().PlayerData then getgenv().PlayerData = {} end
                    getgenv().PlayerData.Rank = uData.Rank
                end

                if uData.Map then
                    isTransitioning = false
                    if not getgenv().PlayerData then getgenv().PlayerData = {} end
                    getgenv().PlayerData.Map = uData.Map
                    task.spawn(function() task.wait(0.5) resetEnemiesList() end)
                end
            end
        end
    end
end)

-- ============================================================================
--  FARMING LOGIC
-- ============================================================================
local function kill(monster)
    local head = monster:FindFirstChild("Head")
    if not head then return end
    local hrpToFeet = (hrp.Size.Y / 2) + (humanoid.HipHeight or 2)
    local targetPosition = getPosition(head) + Vector3.new(5, hrpToFeet - 2, 5)        
    
    if hrp then hrp.CFrame = CFrame.new(targetPosition) end

    local stillTarget = false
    for _, target in pairs(targetList) do
        local mName = monster:GetAttribute("CustomEnemyType") or monster:GetAttribute("ID") or monster.Name
        if mName == target or monster.Name == target then stillTarget = true break end
    end      
    
    while isFarm1 and stillTarget and not isGlobalBossActive and not isTransitioning and not Window.Destroyed do 
        if not head or head.Transparency ~= 0 then break end
        if hrp then hrp.CFrame = CFrame.new(targetPosition) end
        if getDistance(hrp, monster) > distance then return end
        
        stillTarget = false
        for _, target in pairs(targetList) do
            local mName = monster:GetAttribute("CustomEnemyType") or monster:GetAttribute("ID") or monster.Name
            if mName == target or monster.Name == target then stillTarget = true break end
        end
        task.wait()
    end
end

local function check()
    local EnemiesFolder = workspace:FindFirstChild("Client") and workspace.Client:FindFirstChild("Enemies")
    if not EnemiesFolder then return end
    
    for _, monster in pairs(EnemiesFolder:GetChildren()) do
        if isTransitioning or isGlobalBossActive then break end
        if not monster:FindFirstChild("Head") or monster.Head.Transparency ~= 0 then continue end
        if not hrp then task.wait() continue end
        if getDistance(hrp, monster) >= distance then continue end

        local mName = monster:GetAttribute("CustomEnemyType") or monster:GetAttribute("ID") or monster.Name
        for _, target in ipairs(targetList) do
            if (target == mName or target == monster.Name) then
                kill(monster)
                break
            end
        end
    end
end

task.spawn(function()
    while not Window.Destroyed do
        if (isFarm1 == false) or isGlobalBossActive or isTransitioning == true then 
            task.wait(1)
            continue
        end
        check() 
        task.wait()
    end
end)

-- ============================================================================
--  BOSS LOGIC
-- ============================================================================

local function ExecuteKillBoss(bossName)
    local EnemiesFolder = workspace:FindFirstChild("Client") and workspace.Client:FindFirstChild("Enemies")
    if not EnemiesFolder then return end
    
    local targetBoss = nil
    local searchTime = 0
    repeat 
        for _, mob in pairs(EnemiesFolder:GetChildren()) do
            if mob.Name == bossName then targetBoss = mob break end
        end
        task.wait(0.5)
        searchTime = searchTime + 0.5
    until targetBoss or searchTime > 10 
    
    if targetBoss then
        l:Notify({Title="Global Boss", Content="Found " .. bossName .. "! Killing...", Icon="swords"})
        local head = targetBoss:FindFirstChild("Head")
        
        while isGlobalBossActive and targetBoss and targetBoss.Parent and head and head.Transparency == 0 do
            if not hrp then break end
            
            if not isAutoBoss then 
                isGlobalBossActive = false 
                break 
            end

            local targetPos = getPosition(head) + Vector3.new(0, 5, 0)
            hrp.CFrame = CFrame.new(targetPos)
            task.wait()
            if not targetBoss:FindFirstChild("Head") then break end
        end
        
        if isGlobalBossActive then 
            l:Notify({Title="Global Boss", Content="Defeated! Returning...", Icon="check"})
            task.wait(1)
            if savedPreviousMap then SmartTeleport(savedPreviousMap) savedPreviousMap = nil end
        end
        isGlobalBossActive = false 
    else
        l:Notify({Title="Global Boss", Content="Not Found / Despawned", Icon="x"})
        isGlobalBossActive = false
    end
end

local function TriggerGlobalBoss(bossName, mapName)
    if isGlobalBossActive then return end
    if getgenv().PlayerData and getgenv().PlayerData.Map then savedPreviousMap = getgenv().PlayerData.Map else savedPreviousMap = nil end
    isGlobalBossActive = true
    SmartTeleport(mapName)
    ExecuteKillBoss(bossName)
end

TextChatService.MessageReceived:Connect(function(message)
    if Window.Destroyed then return end
    if not isAutoBoss then return end 

    local text = message.Text
    for _, bossName in pairs(selectedBosses) do
        local data = GlobalBossDB[bossName]
        if data and data.Map then
            if string.find(text, bossName) and string.find(text, data.Map) then
                TriggerGlobalBoss(bossName, data.Map)
                break 
            end
        end
    end
end)

-- ============================================================================
--  GAMEMODES: TRIAL & RAID LOGIC
-- ============================================================================

-- [1. DETEKSI WAVE REAL-TIME: TRIAL & RAID]
task.spawn(function()
    local playerGui = LocalPlayer:WaitForChild("PlayerGui")
    
    local function UpdateWaveValue()
        local success, hud = pcall(function() return playerGui:FindFirstChild("Interface") and playerGui.Interface:FindFirstChild("HUD") end)
        if not success or not hud then return end
        
        -- > Update Wave Trial
        local trialNode = hud:FindFirstChild("Gamemodes") and hud.Gamemodes:FindFirstChild("TrialEasy")
        local trialWaveLabel = trialNode and trialNode:FindFirstChild("Background") and trialNode.Background:FindFirstChild("Wave")
        if trialWaveLabel then
            local txt = trialWaveLabel.Text
            local num = string.match(txt, "%d+")
            if num then waveTrial = tonumber(num) end
        end

        -- > Update Wave Raid (NEW)
        local raidNode = hud:FindFirstChild("Gamemodes") and hud.Gamemodes:FindFirstChild("Raid")
        local raidWaveLabel = raidNode and raidNode:FindFirstChild("Background") and raidNode.Background:FindFirstChild("Wave")
        if raidWaveLabel then
            local txt = raidWaveLabel.Text
            local num = string.match(txt, "%d+")
            if num then waveRaid = tonumber(num) end
        end
    end

    while not Window.Destroyed do
        UpdateWaveValue()
        task.wait(2)
    end
end)

-- [2. FUNGSI KILL GENERIC]
local function killGamemodeGeneric(monster, stopConditionFunc)
    local head = monster:FindFirstChild("Head")
    if not head then return end
    local hrpToFeet = (hrp.Size.Y / 2) + (humanoid.HipHeight or 2)
    local targetPosition = getPosition(head) + Vector3.new(5, hrpToFeet - 2, 5)        
    
    while not isGlobalBossActive and not Window.Destroyed do 
        -- Cek Toggle
        if not stopConditionFunc() then break end

        if hrp then hrp.CFrame = CFrame.new(targetPosition) end
        if not head or head.Transparency ~= 0 then break end
        if getDistance(hrp, monster) > distance then return end
        
        task.wait()
    end
end

-- ============================================================================
--  TRIAL LOGIC SPECIFIC
-- ============================================================================
local function checkTrial() 
    while isTrial and not isGlobalBossActive and not Window.Destroyed do
        if waveTrial >= targetWaveTrial then
            isTrial = false
            Notify("Trial", "Target Wave " .. waveTrial .. " Reached!", "check")
            task.wait(0.5)
            if savedPreviousMap and savedPreviousMap ~= "None" and savedPreviousMap ~= "TrialEasy" then
                SmartTeleport(savedPreviousMap)
            else
                SmartTeleport("Trial Lobby")
            end
            return
        end

        local EnemiesFolder = workspace:FindFirstChild("Client") and workspace.Client:FindFirstChild("Enemies")
        if EnemiesFolder then
            for _, monster in pairs(EnemiesFolder:GetChildren()) do
                if not monster:FindFirstChild("Head") or monster.Head.Transparency ~= 0 then continue end
                
                killGamemodeGeneric(monster, function() 
                    return isTrial and waveTrial < targetWaveTrial 
                end)
                
                if isGlobalBossActive or Window.Destroyed or waveTrial >= targetWaveTrial then break end 
                task.wait()
            end
        end
        task.wait(0.5)
    end
end

local function joinDungeon()
    local isTargetTrial = false
    local currentTime = os.date("*t")
    
    for i, trial in pairs(trialList) do
        if trial.time == currentTime.min or (trial.time + 30) == currentTime.min then 
            isTargetTrial = trial.name 
            break 
        end
    end

    if not isTargetTrial then return end

    local currentMap = getgenv().PlayerData and getgenv().PlayerData.Map
    if currentMap and currentMap ~= "TrialEasy" and currentMap ~= "None" then savedPreviousMap = currentMap
    elseif not savedPreviousMap then savedPreviousMap = "Trial Lobby" end

    Notify("Trial", "Auto Joining Trial...", "hourglass")
    task.wait(1)
    for i=1, 5 do
        ReplicatedStorage.BridgeNet2.dataRemoteEvent:FireServer({{"Gamemodes", isTargetTrial, "Join", n = 3}, "\2"})
        task.wait(0.2)
    end
    task.wait(8)
    checkTrial()
end

local function autoFarmDungeon()
    while isTrial and not Window.Destroyed do 
        local currentMap = getgenv().PlayerData and getgenv().PlayerData.Map
        if currentMap == "TrialEasy" then checkTrial()
        elseif not isGlobalBossActive then joinDungeon() end
        task.wait(5)    
    end
end

-- ============================================================================
--  RAID LOGIC SPECIFIC (NEW)
-- ============================================================================
local function checkRaid() 
    while isRaid and not isGlobalBossActive and not Window.Destroyed do
        -- Cek Wave Target
        if waveRaid >= targetWaveRaid then
            isRaid = false
            Notify("Raid", "Target Wave " .. waveRaid .. " Reached!", "check")
            task.wait(0.5)
            if savedPreviousMap and savedPreviousMap ~= "None" and savedPreviousMap ~= "Raid" then
                SmartTeleport(savedPreviousMap)
            else
                SmartTeleport("Raid Lobby") -- Atau map lobby yang sesuai
            end
            return
        end

        local EnemiesFolder = workspace:FindFirstChild("Client") and workspace.Client:FindFirstChild("Enemies")
        if EnemiesFolder then
            for _, monster in pairs(EnemiesFolder:GetChildren()) do
                if not monster:FindFirstChild("Head") or monster.Head.Transparency ~= 0 then continue end
                
                killGamemodeGeneric(monster, function() 
                    return isRaid and waveRaid < targetWaveRaid 
                end)
                
                if isGlobalBossActive or Window.Destroyed or waveRaid >= targetWaveRaid then break end 
                task.wait()
            end
        end
        task.wait(0.5)
    end
end

local function joinRaid()
    -- Cek Waktu Raid (Jika diperlukan, saat ini menggunakan raidJoinList)
    local isTargetRaid = false
    local currentTime = os.date("*t")
    
    -- Logika cek waktu sederhana (atau jika Raid selalu buka, bisa di bypass)
    for i, raid in pairs(raidJoinList) do
        isTargetRaid = raid.name
    end
    -- Fallback: Jika tidak ada di list waktu, coba join langsung (opsional)
    -- isTargetRaid = "Raid" 

    if not isTargetRaid then return end

    local currentMap = getgenv().PlayerData and getgenv().PlayerData.Map
    if currentMap and currentMap ~= "Raid" and currentMap ~= "None" then savedPreviousMap = currentMap
    elseif not savedPreviousMap then savedPreviousMap = "Trial Lobby" end

    Notify("Raid", "Auto Joining Raid...", "hourglass")
    task.wait(1)
    for i=1, 5 do
        -- [RAID JOIN REMOTE]
        ReplicatedStorage.BridgeNet2.dataRemoteEvent:FireServer({{"Gamemodes", "Raid", "Join", n = 3}, "\2"})
        task.wait(0.2)
    end
    task.wait(8)
    checkRaid()
end

local function autoFarmRaid()
    while isRaid and not Window.Destroyed do 
        local currentMap = getgenv().PlayerData and getgenv().PlayerData.Map
        if currentMap == "Raid" then 
            checkRaid()
        elseif not isGlobalBossActive then 
            joinRaid() 
        end
        task.wait(5)    
    end
end


-- Powers & Stronger Loops
local function changePower(name, value) for _, power in pairs(powerList) do if power.name == name then power.auto = value return end end end
task.spawn(function()
    while not Window.Destroyed do
        for _, power in pairs(powerList) do if power.auto == true then ReplicatedStorage.BridgeNet2.dataRemoteEvent:FireServer({{"General", "Gacha", "Roll", power.name, {}, n = 10}, "\2"}) end end
        task.wait(0.5)
    end
end)
task.spawn(function()
    while not Window.Destroyed do
        if targetStar and targetStar ~= "None" then ReplicatedStorage.BridgeNet2.dataRemoteEvent:FireServer({{"General", "Stars", "Open", targetStar, 10, n = 10}, "\2"}) end
        if isRankUp == true and getgenv().PlayerData and GlobalRankDB then
            local pData = getgenv().PlayerData
            local nextRank = (pData.Rank or 0) + 1
            local nextData = GlobalRankDB[nextRank]
            if nextData then
                local reqPower = ParseAbbreviated(nextData.Power)
                local curPower = pData.Power or 0 
                if curPower >= reqPower then
                    ReplicatedStorage.BridgeNet2.dataRemoteEvent:FireServer({{"General", "RankUp", "RankUp", n = 10}, "\2"})
                end
            end
        end
        if isAutoClaimExpedition == true then ReplicatedStorage.BridgeNet2.dataRemoteEvent:FireServer({{"General", "HeroesExpedition", "Claim", n = 3}, "\2"}) end
        if expeditionTarget and expeditionTarget ~= "None" then ReplicatedStorage.BridgeNet2.dataRemoteEvent:FireServer({{"General", "HeroesExpedition", "Start", expeditionTarget, n = 4}, "\2"}) end
        task.wait(0.5) 
    end
end)

-- ============================================================================
--  UI INTERFACE
-- ============================================================================

local BaseProfile = {Banner="rbxassetid://124762019485618", Avatar="rbxassetid://84366761557806", Status=true, Badges={{Icon="geist:logo-discord", Callback=function() setclipboard("https://discord.gg/cy6uMRmeZ") Notify("Discord", "Copied!", "geist:logo-discord") end}, {Icon="youtube", Callback=function() setclipboard("https://www.youtube.com/@ANHubRoblox") Notify("YouTube", "Copied!", "youtube") end}}}
local function MakeProfile(data) local p=table.clone(BaseProfile); for k,v in pairs(data or {}) do p[k]=v end return p end

Window:Tab({Profile = MakeProfile({ Title = "ANHub Script", Desc = "Anime Advanced" }), SidebarProfile = true})
Window:Tag({ Title = "v" .. l.Version, Icon = "github", Color = Color3.fromHex("#ff0000") });

local MainTab = Window:Tab({Title = "Main Feature", Icon = "swords", Profile = MakeProfile({Title = "Game Feature", Desc = "Anime Advanced"}), SidebarProfile = false})

local FM_Categories = {}
local function FM_Add(cat, elem) if not FM_Categories[cat] then FM_Categories[cat]={} end table.insert(FM_Categories[cat], elem) local f=rawget(elem,"ElementFrame") or (elem.UIElements and elem.UIElements.Main) if f then f.Visible=false end return elem end
local function FM_OnChange(selected) for name, elems in pairs(FM_Categories) do local vis=(name==selected) for _, e in ipairs(elems) do local f=rawget(e,"ElementFrame") or (e.UIElements and e.UIElements.Main) if f then f.Visible=vis end end end end

local FM_Category = MainTab:Category({
    Title = "Select Category", Default = "Farm",
    Options = {
        {Title="Farm", Icon="sword"},
        {Title="Bosses", Icon="skull"}, 
        {Title="Gamemodes", Icon="hourglass"}, 
        {Title="Powers", Icon="zap"}, 
        {Title="Upgrade Rank", Icon="chevrons-up"}, 
        {Title="Stronger", Icon="star"}
    },
    Callback = FM_OnChange
})
if FM_Category.ElementFrame then 
    FM_Category.ElementFrame.Parent = MainTab.UIElements.ContainerFrameCanvas 
    FM_Category.ElementFrame.Position = UDim2.new(0,0,0, MainTab.UIElements.ContainerFrame.Position.Y.Offset)
    MainTab.UIElements.ContainerFrame.Position = UDim2.new(0,0,0, MainTab.UIElements.ContainerFrame.Position.Y.Offset + FM_Category.ElementFrame.Size.Y.Offset)
end
MainTab:Space({Columns=1})

-- FARM
UI.EnemyDD = MainTab:Dropdown({
    Title = "Select Enemies", Values = nameList, Multi = false, AllowNone = true, Value = nil, Flag = "TargetEnemies_Cfg",
    Callback = function(v) 
        table.clear(targetList); 
        if v then 
             local val = (type(v) == "table" and (v.Value or v.Title)) or v
             table.insert(targetList, val)
             if not isUpdatingUI and not isTransitioning then
                 local currentMap = getgenv().PlayerData and getgenv().PlayerData.Map
                 if currentMap then SaveMapSelection(currentMap, val) end
             end
        else
             if not isUpdatingUI and not isTransitioning then
                 local currentMap = getgenv().PlayerData and getgenv().PlayerData.Map
                 if currentMap then SaveMapSelection(currentMap, nil) end
             end
        end 
    end
})
FM_Add("Farm", UI.EnemyDD)
FM_Add("Farm", MainTab:Toggle({Title = "Auto Kill Selected", Flag="Farm1_Cfg", Callback = function(v) isFarm1 = v end}))

-- BOSSES
local MapList = {"None"}
task.spawn(function() local added={} for _,data in pairs(GlobalBossDB) do local map = data.Map if map and not added[map] then table.insert(MapList,map) added[map]=true end end end)
local BossListData = {}
for name, data in pairs(GlobalBossDB) do
    local bossDropIcons = {}
    if data.Drops then
        for _, drop in ipairs(data.Drops) do
            if drop.Item then
                local iconFound = nil
                if drop.Type == "Sword" then local swordData = GlobalSwordDB[drop.Item] if swordData then iconFound = swordData.Icon end
                else local itemData = GlobalItemDB[drop.Item] if itemData then iconFound = itemData.Icon end end
                if iconFound then table.insert(bossDropIcons, iconFound) end
            end
        end
    end
    table.insert(BossListData, {Title = name .. " [" .. (data.Difficult or "Boss") .. "]", Desc = "HP: " .. (data.Health or "?"), Value = name, Icon = CharacterIcons[name] or nil, Images = bossDropIcons})
end
table.sort(BossListData, function(a,b) return a.Value < b.Value end)

FM_Add("Bosses", MainTab:Toggle({Title = "Enable Auto Boss Hunt", Desc = "Turn this ON to auto-detect Bosses from chat.", Flag = "AutoBoss_Master_Cfg", Callback = function(v) isAutoBoss = v if not v then isGlobalBossActive = false end end}))
FM_Add("Bosses", MainTab:Dropdown({Title = "Select Boss Targets", Values = BossListData, Multi = true, AllowNone = true, Flag = "GlobalBoss_Selection", Callback = function(val) selectedBosses = {} if type(val) == "table" then for _, v in ipairs(val) do table.insert(selectedBosses, (type(v)=="table" and v.Value) or v) end else selectedBosses = val end end}))
FM_Add("Bosses", MainTab:Button({Title = "Force Start / Scan Current Map", Desc = "Manually check if a selected boss is in the current map", Icon = "swords", Callback = function() isAutoBoss = true local found = false local EnemiesFolder = workspace:FindFirstChild("Client") and workspace.Client:FindFirstChild("Enemies") if EnemiesFolder then for _, mob in pairs(EnemiesFolder:GetChildren()) do for _, targetName in pairs(selectedBosses) do if mob.Name == targetName then found = true isGlobalBossActive = true ExecuteKillBoss(targetName) break end end if found then break end end end if not found then Notify("System", "No selected boss found here.", "search") end end}))
-- FM_Add("Bosses", MainTab:Toggle({Title = "Active Status", Desc = "Shows if Global Boss Logic is running (Read Only)", Value = false, Callback = function(v) if not v then isGlobalBossActive = false end end, Flag = "GlobalBoss_Status"}))

-- GAMEMODES (Trial & Raid)
local TrialNames = {} for _, t in ipairs(trialList) do table.insert(TrialNames, t.name) end
FM_Add("Gamemodes", MainTab:Dropdown({Title="Trial Selection", Values=TrialNames, Multi=true, Flag="TrialSelect_Cfg", Callback=function(v) end})) -- Selection placeholder, currently using trialList generic
FM_Add("Gamemodes", MainTab:Input({Title="Target Wave (Trial)", Value="500", Flag="WaveTarget_Cfg", Callback=function(v) targetWaveTrial = tonumber(v) or 500 end}))
FM_Add("Gamemodes", MainTab:Toggle({Title="Auto Farm Trial", Flag="AutoTrial_Cfg", Callback=function(v) isTrial = v; if v then task.spawn(autoFarmDungeon) end end}))

FM_Add("Gamemodes", MainTab:Input({Title="Target Wave (Raid)", Value="50", Flag="WaveTargetRaid_Cfg", Callback=function(v) targetWaveRaid = tonumber(v) or 50 end}))
FM_Add("Gamemodes", MainTab:Toggle({Title="Auto Farm Raid", Flag="AutoRaid_Cfg", Callback=function(v) isRaid = v; if v then task.spawn(autoFarmRaid) end end}))

-- POWERS
for _, power in ipairs(powerList) do FM_Add("Powers", MainTab:Toggle({Title="Auto "..power.name, Flag="Power_"..power.name, Callback=function(v) changePower(power.name, v) end})) end

-- UPGRADE RANK
UI.RankInfo = MainTab:Paragraph({Title = "Rank Info: Loading...", Desc = "Waiting for Player Data...", Image = "rbxassetid://108641720461944"})
FM_Add("Upgrade Rank", UI.RankInfo)
FM_Add("Upgrade Rank", MainTab:Toggle({Title="Auto Rank Up", Flag="RankUp_Cfg", Callback=function(v) isRankUp = v end}))
task.spawn(function()
    while not Window.Destroyed do
        if getgenv().PlayerData and getgenv().PlayerData.Rank and #GlobalRankDB > 0 then
            local currentRankIdx = getgenv().PlayerData.Rank
            local nextRankIdx = currentRankIdx + 1
            local currentPower = getgenv().PlayerData.Power or 0
            local currentRankData = GlobalRankDB[currentRankIdx]
            local nextRankData = GlobalRankDB[nextRankIdx]
            if currentRankData and nextRankData then
                local nextRankPowerReq = ParseAbbreviated(nextRankData.Power)
                local currentPerkPower = (currentRankData.Perks and currentRankData.Perks.Power) or "0"
                local nextPerkPower = (nextRankData.Perks and nextRankData.Perks.Power) or "0"
                local progress = 0
                if nextRankPowerReq > 0 then progress = math.clamp(currentPower / nextRankPowerReq, 0, 1) end
                local progressPercent = math.floor(progress * 100)
                local bars = 20
                local filled = math.floor(progress * bars)
                local empty = bars - filled
                local barStr = string.rep("■", filled) .. string.rep("□", empty)
                if UI.RankInfo then
                    UI.RankInfo:SetTitle(string.format("Rank %d > Rank %d", currentRankIdx, nextRankIdx))
                    UI.RankInfo:SetDesc(string.format("Perks x%s > x%s\n%s %d%%\nPower: %s / %s", currentPerkPower, nextPerkPower, barStr, progressPercent, FormatNumber(currentPower), nextRankData.Power))
                end
            else
                 if UI.RankInfo then UI.RankInfo:SetTitle("Max Rank Reached") UI.RankInfo:SetDesc("You have reached the maximum rank!") end
            end
        end
        task.wait(1)
    end
end)

-- STRONGER
FM_Add("Stronger", MainTab:Toggle({Title="Auto Claim Heroes Expedition", Flag="ClaimExp_Cfg", Callback=function(v) isAutoClaimExpedition = v end}))
FM_Add("Stronger", MainTab:Dropdown({Title="Expedition Map", Values=MapList, Value="None", Flag="ExpTarget_Cfg", Callback=function(v) expeditionTarget = (type(v)=="table" and v.Title) or v end}))
FM_Add("Stronger", MainTab:Dropdown({Title="Auto Hatch (Star)", Values=MapList, Value="None", Flag="HatchTarget_Cfg", Callback=function(v) targetStar = (type(v)=="table" and v.Title) or v end}))

-- SETTINGS TAB
local SettingsTab = Window:Tab({Title = "Settings", Icon = "settings-2"})
local ConfigSection = SettingsTab:Section({Title = "Config Manager", Icon = "save", Opened = true})
SettingsTab:Input({Title = "Config Name", Placeholder = "AN_AnimeAdvanced", Flag = "ConfigName_Input", Callback = function(txt) ConfigName = txt end})
SettingsTab:Button({Title = "Save Config", Icon = "save", Callback = function() local cfg = Window.ConfigManager:CreateConfig(ConfigName) cfg:Save() Notify("Config", "Saved!", "check") end})
SettingsTab:Button({Title = "Load Config", Icon = "upload", Callback = function() local cfg = Window.ConfigManager:GetConfig(ConfigName) or Window.ConfigManager:CreateConfig(ConfigName); if cfg then cfg:Load(); Notify("Config", "Loaded!", "check") end end})
SettingsTab:Button({Title = "Delete Config", Icon = "trash", Callback = function() Window.ConfigManager:DeleteConfig(ConfigName); Notify("Config", "Deleted!", "trash") end})
SettingsTab:Button({Title = "Reduce Lag / FPS Boost", Icon = "monitor", Callback = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/khuyenbd8bb/RobloxKaitun/refs/heads/main/FPS%20Booster.lua"))() Notify("System", "Boosted!", "check") end})

FM_OnChange("Farm")
Window:SelectTab(MainTab.Index)

-- ============================================================================
--  INITIALIZATION
-- ============================================================================
task.spawn(function()
    task.wait(1.5)
    local CM = Window.ConfigManager
    pcall(function()
        if isfile(ConfigPath .. "/" .. ConfigName .. ".json") then
            local cfg = CM:CreateConfig(ConfigName)
            cfg:Load()
            Notify("Config", "Auto-Loaded", "check")
        else
            CM:CreateConfig(ConfigName)
        end
    end)
    repeat task.wait(1) if not getgenv().PlayerData then ScanPlayerData() end until getgenv().PlayerData
    resetEnemiesList()
    pcall(function()
        local args = {{{"General", "Settings", "Update", "Auto Rejoin", false, n = 5}, "\2"}}
        ReplicatedStorage:WaitForChild("BridgeNet2"):WaitForChild("dataRemoteEvent"):FireServer(unpack(args))
    end)
    while not Window.Destroyed do
        task.wait(1)
        pcall(function() local cfg = Window.ConfigManager:GetConfig(ConfigName) if cfg then cfg:Save() end end)
    end
end)
