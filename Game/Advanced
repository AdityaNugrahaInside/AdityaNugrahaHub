repeat
    task.wait();
until game:IsLoaded();

-- [LOADING SCREEN]
loadstring(game:HttpGet("https://raw.githubusercontent.com/ANHub-Script/ANUI/refs/heads/main/dist/loading2.lua"))()

-- [CONFIG PATHS - SYSTEM SEPERTI YUHU]
local FolderPath = "ANUI/AnimeAdvanced";
local ExpiryFile = FolderPath .. "/ANHub_Key_Timer.txt";
local LocationDB = FolderPath .. "/Location_DB.json"; -- Pengganti TigerHubAA/locationList.json

if not isfolder("ANUI") then makefolder("ANUI") end
if not isfolder(FolderPath) then makefolder(FolderPath) end
if not isfolder(FolderPath .. "/Config") then makefolder(FolderPath .. "/Config") end

-- [SECURE WIPE / KEY SYSTEM LOGIC]
local function SecureWipe()
    if not isfile or (not delfile) or (not readfile) or (not listfiles) then
        return;
    end;
    local currentTime = os.time();
    local isExpired = false;

    if isfile(ExpiryFile) then
        local savedTime = tonumber(readfile(ExpiryFile)) or 0;
        if currentTime > savedTime then
            isExpired = true;
        end;
    elseif isfolder(FolderPath) then
        isExpired = true;
    end;

    if isExpired then
        if isfile(ExpiryFile) then
            delfile(ExpiryFile);
        end;
        local UserId = tostring(game:GetService("Players").LocalPlayer.UserId);
        if isfolder(FolderPath) then
            for _, file in pairs(listfiles(FolderPath)) do
                if string.find(file, ".key") or string.find(file, UserId) then
                    pcall(function()
                        delfile(file);
                    end);
                end;
            end;
        end;
        task.wait(0.5);
    end;
end;
SecureWipe();

-- [SERVICES & LOCALS]
local Players = game:GetService("Players");
local LocalPlayer = Players.LocalPlayer;
local HttpService = game:GetService("HttpService");
local VirtualUser = game:GetService('VirtualUser')
local TextChatService = game:GetService("TextChatService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- [UI LIBRARY INIT]
local l = loadstring(game:HttpGet("https://raw.githubusercontent.com/ANHub-Script/ANUI/refs/heads/main/dist/main.lua?v="..math.random()))();

-- [HELPER FUNCTIONS KEY]
local function GetOnlineKeys()
    local keys = { "Keynya", "FreeKey" };
    local url = "https://raw.githubusercontent.com/AdityaNugrahaInside/ANHub/refs/heads/main/Key";
    local success, response = pcall(function()
        return game:HttpGet(url);
    end);
    if success then
        keys = {};
        for line in response:gmatch("[^\r\n]+") do
            local cleanKey = string.gsub(line, "^%s*(.-)%s*$", "%1");
            if cleanKey ~= "" then
                table.insert(keys, cleanKey);
            end;
        end;
    end;
    return keys;
end;

-- ============================================================================
--  UI WINDOW CREATION
-- ============================================================================

local Window = l:CreateWindow({
    Title = "AN Hub - Anime Advanced",
    Icon = "rbxassetid://84366761557806",
    Author = "Aditya Nugraha",
    Folder = "AnimeWeapons", -- Folder ConfigManager
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true,
    Theme = "Dark",
    Resizable = true,
    SideBarWidth = 220,
    HideSearchBar = true,
    ToggleKey = Enum.KeyCode.RightControl,
    KeySystem = {
        Enabled = true,
        Title = "ANHub Access",
        Description = "Key expires every 24 Hours!",
        Key = GetOnlineKeys(),
        URL = "https://discord.gg/cy6uMRmeZ",
        Note = "Join Discord for Key",
        SaveKey = true
    }
});

task.delay(1.0, function() Window:CollapseSidebar() end)
task.delay(3.0, function() Window:ExpandSidebar() end)

local function Notify(title, content, icon)
    if l then l:Notify({ Title = title, Content = content, Icon = icon, Duration = 3 }) end
end

-- ============================================================================
--  GAME LOGIC (VARIABLES & FUNCTIONS)
-- ============================================================================

-- Local Vars
local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")
local humanoid = character:WaitForChild("Humanoid")

-- MMain
local HatchGui = LocalPlayer:WaitForChild("PlayerGui")
local attackRangePart 
local distance = 10000
local farm2Delay = 0.1
local dontTeleport
local gachaZone
local attackRange 
local inGamemode
-- FFarm
local monsterList = {}; local nameList = {}; local targetList = {}
local isAutoJoinRaid = false; 
local locationList = {}; local locationNumber = {}; 
local locationTargetList = {}
local isTeleportFarm = false
-- Boss
local toogleBoss = {}; local bossList = {};
-- DDungeon, Raid, Trial
local waveRaid = 0; local waveDungeon = 0; local waveDef = 0; local waveTrial = 0;
local targetWaveRaid = 500; local targetWaveDef = 500; 
local targetWaveDungeon = 500; local targetWaveTrial = 500;
local trialList = {}; local targetTrial = {};
local isTrial = false
-- PPowers
local powerList = {}; local tooglePower = {};
-- SStronger
local isAutoClaimExpedition = false;
local toogleStar = {}
local targetStar = "None"; local expeditionTarget = "None";
local teleportBackMap = "None";  
local isTele = false
local repeatTime = 1
local isHatch = false
local isFarm1 = false
local isFarm2 = false
local isRankUp = false
local currentTime = os.date("*t")
local isAutoAttack = false

-- Anti AFK
LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- Character Added
LocalPlayer.CharacterAdded:Connect(function(newChar)
    character = newChar
    hrp = newChar:WaitForChild("HumanoidRootPart")
    humanoid = newChar:WaitForChild("Humanoid")
end)

-- [LOOP: ATTACK RANGE]
task.spawn(function()
    while not Window.Destroyed do
        attackRangePart = workspace:FindFirstChild("Cache") and workspace.Cache:FindFirstChild("Area")
        if not attackRangePart then 
            task.wait(1)
            continue
        end
        attackRange = attackRangePart.Size.X/2
        task.wait(1)
    end
end)

-- Utils
local function getPosition(obj1)
    if obj1:IsA("Model") then
        return obj1:GetPivot().Position
    elseif obj1:IsA("BasePart") then
        return obj1.Position
    else
        return nil
    end
end

local function getDistance(obj1, obj2)
    local pos1, pos2
    if obj1:IsA("Model") then
        pos1 = obj1:GetPivot().Position
    elseif obj1:IsA("BasePart") then
        pos1 = obj1.Position
    end

    if obj2:IsA("Model") then
        pos2 = obj2:GetPivot().Position
    elseif obj2:IsA("BasePart") then
        pos2 = obj2.Position
    end
    
    if pos1 and pos2 then
        return (pos1 - pos2).Magnitude
    end
    return 999999
end

local function DecodeJSON(str)
    local success, result = pcall(function() return HttpService:JSONDecode(str) end)
    if success then return result else return {} end
end

-- [REPLACED: Manual Load Logic replaced with simple Location DB loader]
local function loadLocationDB()
    if isfile(LocationDB) then
        local content = readfile(LocationDB)
        local data = DecodeJSON(content)
        locationList = {}
        locationNumber = {}
        
        for i, v in ipairs(data) do
            if v.pos and v.number then
                -- Parse Vector3 string if needed or load directly
                local vec
                if type(v.pos) == "string" then
                    local x, y, z = v.pos:match("Vector3_%(([%d%.%-]+),%s*([%d%.%-]+),%s*([%d%.%-]+)%)")
                    if x then vec = Vector3.new(tonumber(x), tonumber(y), tonumber(z)) end
                end
                
                if vec then
                    table.insert(locationList, {number = v.number, pos = vec})
                    table.insert(locationNumber, v.number)
                end
            end
        end
    end
end

-- Boss Functions
local function teleportToMap(map)
    if not map or map == "None" then return end
    isTele = true
    local dataRemoteEvent = ReplicatedStorage.BridgeNet2.dataRemoteEvent
    dataRemoteEvent:FireServer({{"Player", "Teleport", "Teleport", map, n = 4}, "\2"})
    task.wait(5)
    isTele = false
end

local function killBoss(bossName, index)
    local EnemiesFolder = workspace:FindFirstChild("Client") and workspace.Client:FindFirstChild("Enemies")
    if not EnemiesFolder then return end
    
    local Monster = EnemiesFolder:GetChildren()
    for _, monster in pairs(Monster) do
        if monster.Name ~= bossName then continue end
        local head = monster:FindFirstChild("Head")
        if not head then continue end
        
        local hrpToFeet = (hrp.Size.Y / 2) + (humanoid.HipHeight or 2)
        local safeHeight = -2
        local headPos = getPosition(head)
        local targetPosition = headPos + Vector3.new(5, hrpToFeet + safeHeight, 5)        
    
        while inGamemode and bossList[index].kill and not Window.Destroyed do -- Safe Check
            if not head or head.Transparency ~= 0 then break end
            if hrp then hrp.CFrame = CFrame.new(targetPosition) end
            
            if getDistance(hrp, monster) > distance then return end
            task.wait()
        end
    end
end

local function foundBoss(text) 
    for i, boss in ipairs(bossList) do
        if string.find(text, boss.name) and string.find(text, boss.map) then 
            if boss.kill == true then 
                return i
            end
        end
    end
    return false
end

TextChatService.MessageReceived:Connect(function(message)
    if Window.Destroyed then return end -- Safe Check
    if not message or foundBoss(message.Text) == false then return end
    inGamemode = true
    task.wait(0.5)
    local bossIndex = foundBoss(message.Text)
    if bossIndex then
        teleportToMap(bossList[bossIndex].map)
        killBoss(bossList[bossIndex].name, bossIndex)
        teleportToMap(teleportBackMap)
    end
    inGamemode = false
end)

-- Farm Functions
local function resetEnemiesList()
    local EnemiesFolder = workspace:FindFirstChild("Client") and workspace.Client:FindFirstChild("Enemies")
    if not EnemiesFolder then return end
    
    local monsters = EnemiesFolder:GetChildren()
    local nameSet = {}
    table.clear(nameList)
    table.clear(monsterList)
    
    for _, monster in pairs(monsters) do
        if monster.Name == "" or not monster.Name then continue end
        local nameText = monster.Name
        
        if not monster:FindFirstChild("Head") or monster.Head.Transparency ~= 0 then continue end
        if not monster:FindFirstChild("HumanoidRootPart") or getDistance(hrp, monster.HumanoidRootPart) >= distance then continue end

        if not nameSet[nameText] then
            table.insert(monsterList, nameText)
            nameSet[nameText] = true
            table.insert(nameList, nameText)
        end
    end
    -- No manual save needed here, handled by UI refresh
end

local function kill(monster)
    local head = monster:FindFirstChild("Head")
    if not head then return end
    local hrpToFeet = (hrp.Size.Y / 2) + (humanoid.HipHeight or 2)
    local safeHeight = -2
    local headPos = getPosition(head)
    local targetPosition = headPos + Vector3.new(5, hrpToFeet + safeHeight, 5)        
    
    if hrp then hrp.CFrame = CFrame.new(targetPosition) end

    local stillTarget = false
    for _, target in pairs(targetList) do
        if monster.Name == target then stillTarget = true break end
    end   
    
    while isFarm1 and stillTarget and inGamemode == false and not Window.Destroyed do -- Safe Check
        if not head or head.Transparency ~= 0 then break end
        if hrp then hrp.CFrame = CFrame.new(targetPosition) end
        
        if getDistance(hrp, monster) > distance then return end
        
        stillTarget = false
        for _, target in pairs(targetList) do
            if monster.Name == target then stillTarget = true break end
        end
        task.wait()
    end
end

local function kill2(monster)
    local head = monster:FindFirstChild("Head")
    if not head then return end
    local hrpToFeet = (hrp.Size.Y / 2) + (humanoid.HipHeight or 2)
    local safeHeight = -2
    local headPos = getPosition(head)
    local targetPosition = headPos + Vector3.new(5, hrpToFeet + safeHeight, 5)        
    
    if hrp then hrp.CFrame = CFrame.new(targetPosition) end
    task.wait(farm2Delay)
end

local function check()
    local EnemiesFolder = workspace:FindFirstChild("Client") and workspace.Client:FindFirstChild("Enemies")
    if not EnemiesFolder then return end
    local monsters = EnemiesFolder:GetChildren()
    
    for _, monster in pairs(monsters) do
        if not isFarm1 and not isFarm2 then break end
        if inGamemode then break end
        if not monster:FindFirstChild("Head") then continue end
        local Head = monster.Head
        if Head.Transparency ~= 0 then continue end
        if not hrp then task.wait() continue end
        
        local dis = getDistance(hrp, monster)
        if dis >= distance or dis <= attackRange then continue end

        if monster.Name == "" or not monster.Name then continue end
        local nameText = monster.Name

        for _, target in ipairs(targetList) do
            if (target == nameText) then
                if inGamemode then break end
                if isFarm1 then kill(monster) end
                if isFarm2 then kill2(monster) end
                break
            end
        end
    end
end

-- [LOOP: FARM CHECK]
task.spawn(function()
    while not Window.Destroyed do
        if (isFarm1 == false and isFarm2 == false) or inGamemode or isTele == true then 
            task.wait(1)
            continue
        end
        check() 
        task.wait()
    end
end)

-- Location Functions
local function teleportTo(targetNumber)
    for _, location in ipairs(locationList) do
        if (location.number == targetNumber) then
            local Pos = location.pos
            if (getPosition(hrp) - Pos).Magnitude > distance then return end
            
            local targetPosition = Pos        
            if inGamemode or isTele then return end 
            if hrp then hrp.CFrame = CFrame.new(targetPosition) end
            break
        end
    end
    task.wait(repeatTime)
end

local function autoTeleportFarmLoop()
    while isTeleportFarm and not Window.Destroyed do -- Safe Check
        if inGamemode or isTele then 
            task.wait(1)
            continue 
        end
        for _, location in ipairs(locationTargetList) do
            if not isTeleportFarm or Window.Destroyed then break end -- Safe Check
            teleportTo(location)
        end
        task.wait()
    end
end

local function addLocationFunc()
    if not hrp then return end
    local Position = hrp.Position
    local size = #locationList
    local name = "Location #" .. tostring(size + 1)
    
    table.insert(locationList, {number = name, pos = Position})
    
    local saveList = {}
    for _, v in ipairs(locationList) do
        table.insert(saveList, {
            number = v.number,
            pos = string.format("Vector3_(%f, %f, %f)", v.pos.X, v.pos.Y, v.pos.Z)
        })
    end
    
    -- [SAVING] Manual save for locations to LocationDB
    if writefile then
        writefile(LocationDB, HttpService:JSONEncode(saveList))
    end
    
    table.clear(locationNumber)
    for _, l in ipairs(locationList) do
        table.insert(locationNumber, l.number)
    end
end

-- Power Functions
local function changePower(name, value)
    for _, power in pairs(powerList) do
        if power.name == name then 
            power.auto = value
            return
        end
    end
end

-- [LOOP: POWER ROLL]
task.spawn(function()
    while not Window.Destroyed do
        for _, power in pairs(powerList) do
            if power.auto == true then
                local name = power.name
                local dataRemoteEvent = ReplicatedStorage.BridgeNet2.dataRemoteEvent
                dataRemoteEvent:FireServer({{"General", "Gacha", "Roll", name, {}, n = 10}, "\2"})
            end
        end
        task.wait(0.5)
    end
end)

-- [LOOP: RAID JOIN]
task.spawn(function()
    while not Window.Destroyed do
        if isAutoJoinRaid then
            local dataRemoteEvent = ReplicatedStorage.BridgeNet2.dataRemoteEvent
            dataRemoteEvent:FireServer({{"Gamemodes", "Raid", "Join", n = 3}, "\2"})
        end
        task.wait(5)
    end
end)

local function killDungeon(monster)
    local head = monster:FindFirstChild("Head")
    if not head then return end
    local hrpToFeet = (hrp.Size.Y / 2) + (humanoid.HipHeight or 2)
    local safeHeight = -2
    local headPos = getPosition(head)
    local targetPosition = headPos + Vector3.new(5, hrpToFeet + safeHeight, 5)        

    while isTrial and isTele == false and inGamemode and not Window.Destroyed do -- Safe Check
        if hrp then hrp.CFrame = CFrame.new(targetPosition) end
        if not head or head.Transparency ~= 0 then break end
        if getDistance(hrp, monster) > distance then return end
        task.wait()
    end
end

-- Trial Wave Gui Detection
task.spawn(function()
    local success, trialGui = pcall(function() return game:GetService("StarterGui").Interface.HUD.Gamemodes.TrialEasy.Background.Wave end)
    if success and trialGui then
        trialGui:GetPropertyChangedSignal("Text"):Connect(function()
            waveTrial = tonumber((string.gsub(trialGui.Text, "Wave ", "")))
        end)
    end
end)

local function checkTrial() 
    while waveDungeon <= targetWaveDungeon 
     and waveRaid <= targetWaveRaid 
     and waveDef <= targetWaveDef 
     and waveTrial <= targetWaveTrial and
     isTele == false and inGamemode and not Window.Destroyed do -- Safe Check
        
        local EnemiesFolder = workspace:FindFirstChild("Client") and workspace.Client:FindFirstChild("Enemies")
        if EnemiesFolder then
            local monsters = EnemiesFolder:GetChildren()
            for _, monster in pairs(monsters) do
                local Head = monster:FindFirstChild("Head")
                if not Head or Head.Transparency ~= 0 then continue end
                if not hrp then task.wait() continue end
                
                local dis = getDistance(hrp, monster)
                if dis >= distance or dis <= attackRange then continue end
                killDungeon(monster)
                if not inGamemode or isTele or Window.Destroyed then break end -- Safe Check
                task.wait()
            end
        end
        
        if waveTrial >= targetWaveTrial then
            if (waveTrial > targetWaveTrial) then
                teleportToMap(teleportBackMap)
                return
            else
                task.wait(2)
                if EnemiesFolder and #EnemiesFolder:GetChildren() == 0 then 
                    teleportToMap(teleportBackMap)
                    return
                end
            end
        end 
        task.wait()
    end
end

local function joinDungeon()
    local isTargetTrial = false
    currentTime = os.date("*t")
    for i, trial in pairs(trialList) do
        if trialList[i].time == currentTime.min or trialList[i].time + 30 == currentTime.min then 
            isTargetTrial = trial.name
            break
        end
    end
    if not isTargetTrial then return end
    
    inGamemode = true
    task.wait(1)
    local dataRemoteEvent = ReplicatedStorage.BridgeNet2.dataRemoteEvent
    dataRemoteEvent:FireServer({{"Gamemodes", isTargetTrial, "Join", n = 3}, "\2"})
    task.wait(8)
    checkTrial()
    inGamemode = false
end

local function autoFarmDungeon()
    while isTrial and not Window.Destroyed do -- Safe Check
        if not inGamemode then
            waveTrial = 0
            joinDungeon()
        end
        task.wait(1)    
    end
end

-- [LOOP: STRONGER STAR OPEN]
task.spawn(function()
    while not Window.Destroyed do
        if targetStar and targetStar ~= "None" then
            local dataRemoteEvent = ReplicatedStorage.BridgeNet2.dataRemoteEvent
            dataRemoteEvent:FireServer({{"General", "Stars", "Open", targetStar, 10, n = 10}, "\2"})
        end
        task.wait(0.2)
    end
end)

-- [LOOP: STRONGER MISC]
task.spawn(function()
    while not Window.Destroyed do
        local dataRemoteEvent = ReplicatedStorage.BridgeNet2.dataRemoteEvent
        if isRankUp == true then
            dataRemoteEvent:FireServer({{"General", "RankUp", "RankUp", n = 10}, "\2"}) 
        end
        if isAutoClaimExpedition == true then
            dataRemoteEvent:FireServer({{"General", "HeroesExpedition", "Claim", n = 3}, "\2"}) 
        end
        if expeditionTarget and expeditionTarget ~= "None" then
            dataRemoteEvent:FireServer({{"General", "HeroesExpedition", "Start", expeditionTarget, n = 4}, "\2"})
        end
        task.wait(5)
    end
end)

-- Populate Static Lists
table.insert(powerList, {name = "Hero Rank", auto = false})
table.insert(powerList, {name = "Ninja Rank", auto = false})
table.insert(powerList, {name = "Haki", auto = false})
table.insert(powerList, {name = "Passive", auto = false})
table.insert(powerList, {name = "Clan", auto = false})

bossList = {
    {name = "Sea King", map = "XYZ Metropolis", kill = false},
    {name = "Cosmic Garo", map = "XYZ Metropolis", kill = false},
    {name = "Itachu", map = "Ninja Village", kill = false},
    {name = "Nanko", map = "Ninja Village", kill = false},
    {name = "Luciu", map = "Forgotten Shore", kill = false},
    {name = "Hawkeye", map = "Forgotten Shore", kill = false},
    {name = "Hantengo", map = "Slayer Forest", kill = false},
    {name = "Kokushibe", map = "Slayer Forest", kill = false}
}

trialList = {
    {name = "TrialEasy", time = 15}
}

-- Initialize Data (Locations only, Flags handled by UI)
loadLocationDB()

-- ============================================================================
--  UI CONSTRUCTION
-- ============================================================================

-- [PROFILES]
local BaseProfile = {
    Banner = "rbxassetid://124762019485618", 
    Avatar = "rbxassetid://84366761557806", 
    Status = true,
    Badges = {
        {
            Icon = "geist:logo-discord", 
            Callback = function() setclipboard("https://discord.gg/cy6uMRmeZ") Notify("Discord", "Copied!", "geist:logo-discord") end
        },
        {
            Icon = "youtube", 
            Callback = function() setclipboard("https://www.youtube.com/@ANHubRoblox") Notify("YouTube", "Copied!", "youtube") end
        }
    }
}

local function MakeProfile(data)
    local p = table.clone(BaseProfile)
    for k, v in pairs(data or {}) do 
        p[k] = v 
    end
    return p
end

Window:Tab({
    Profile = MakeProfile({ Title = "ANHub Script", Desc = "Anime Advanced" }),
    SidebarProfile = true
})

do
    Window:Tag({ Title = "v" .. l.Version, Icon = "github", Color = Color3.fromHex("#ff0000") });
end;

-- [TAB: MAIN FEATURE (ALL HHH FEATURES)]
local MainTab = Window:Tab({
    Title = "Main Feature",
    Icon = "swords", 
    Profile = MakeProfile({ Title = "Game Feature", Desc = "Anime Advanced" }),
    SidebarProfile = false
});

-- Category System Logic
local FM_Categories = {}
local FM_CategoryDescriptions = {
    ["Farm"] = "Enemies Farming",
    ["Locations"] = "Location Manager",
    ["Teleport"] = "Map Teleportation",
    ["Bosses"] = "Boss Auto-Kill",
    ["Trial"] = "Dungeon & Trials",
    ["Powers"] = "Stat Upgrades",
    ["Stronger"] = "Progression",
    ["Settings"] = "Configuration" -- Added Settings to desc
}

local function FM_GetElementFrame(elem)
    local f = rawget(elem, "ElementFrame") or (elem.UIElements and elem.UIElements.Main) or rawget(elem, "GroupFrame") or rawget(elem, "ParagraphFrame")
    return f
end
local function FM_Add(cat, elem)
    if not FM_Categories[cat] then FM_Categories[cat] = {} end
    table.insert(FM_Categories[cat], elem)
    local frame = FM_GetElementFrame(elem)
    if frame then frame.Visible = false end
    return elem
end
local function FM_UpdateTabProfile(selected)
    local desc = FM_CategoryDescriptions[selected] or ""
    if MainTab.UIElements.ContainerFrameCanvas then
        local header = MainTab.UIElements.ContainerFrameCanvas:FindFirstChild("ProfileHeader") or MainTab.UIElements.ContainerFrame:FindFirstChild("ProfileHeader")
        if header then
            local tc = header:FindFirstChild("TextContainer")
            if tc then
                local labels = tc:GetChildren()
                for _, c in ipairs(labels) do
                    if c:IsA("TextLabel") and c.LayoutOrder == 1 then c.Text = selected end
                    if c:IsA("TextLabel") and c.LayoutOrder == 2 then c.Text = desc end
                end
            end
        end
    end
end
local function FM_OnChange(selected)
    for name, elems in pairs(FM_Categories) do
        local vis = (name == selected)
        for _, e in ipairs(elems) do
            local f = FM_GetElementFrame(e)
            if f then f.Visible = vis end
        end
    end
    pcall(function() FM_UpdateTabProfile(selected) end)
end

local FM_Category = MainTab:Category({
    Title = "Select Category",
    Default = "Farm",
    Options = {
        {Title="Farm", Icon="sword"},
        {Title="Locations", Icon="map-pin"},
        {Title="Teleport", Icon="plane"},
        {Title="Bosses", Icon="skull"},
        {Title="Trial", Icon="hourglass"},
        {Title="Powers", Icon="zap"},
        {Title="Stronger", Icon="star"}
        -- Settings will be handled by a separate Tab for ConfigManager consistency like Yuhu
    },
    Callback = FM_OnChange
})

-- Fix Sticky Category
if FM_Category and FM_Category.ElementFrame and MainTab.UIElements.ContainerFrameCanvas then
    local CategoryFrame = FM_Category.ElementFrame
    local Canvas = MainTab.UIElements.ContainerFrameCanvas
    local ScrollFrame = MainTab.UIElements.ContainerFrame
    
    CategoryFrame.Parent = Canvas
    local startY = ScrollFrame.Position.Y.Offset
    CategoryFrame.Position = UDim2.new(0, 0, 0, startY)
    
    local catHeight = CategoryFrame.Size.Y.Offset
    local newY = startY + catHeight
    
    ScrollFrame.Position = UDim2.new(0, 0, 0, newY)
    ScrollFrame.Size = UDim2.new(1, 0, 1, -newY)
end

MainTab:Space({Columns=1})

-- ==================== CATEGORY: FARM ====================
local EnemyDropdown = MainTab:Dropdown({
    Title = "Select Enemies",
    Values = nameList,
    Multi = true,
    Value = {},
    SearchBarEnabled = true,
    Flag = "TargetList_Cfg", -- [ADDED FLAG]
    Callback = function(selectedValues)
        table.clear(targetList)
        if type(selectedValues) == "table" then
            for _, item in ipairs(selectedValues) do
                local name = type(item) == "table" and item.Title or item
                table.insert(targetList, name)
            end
        end
    end
})
FM_Add("Farm", EnemyDropdown)

local ResetEnemiesBtn = MainTab:Button({
    Title = "Reset Enemies List",
    Desc = "Update list from current map",
    Icon = "refresh-cw",
    Callback = function() 
        resetEnemiesList()
        local newValues = {}
        for _, v in ipairs(nameList) do table.insert(newValues, v) end
        EnemyDropdown:Refresh(newValues)
        Notify("Farm", "Enemies list reset!", "check")
    end
})
FM_Add("Farm", ResetEnemiesBtn)

local Farm1Toggle = MainTab:Toggle({
    Title = "Auto Kill Selected (Method 1)",
    Value = false,
    Flag = "Farm1_Cfg", -- [ADDED FLAG]
    Callback = function(v) isFarm1 = v end
})
FM_Add("Farm", Farm1Toggle)

local Farm2Toggle = MainTab:Toggle({
    Title = "Auto Kill Selected (Method 2)",
    Desc = "Only for 1-hit kill (Instant)",
    Value = false,
    Flag = "Farm2_Cfg", -- [ADDED FLAG]
    Callback = function(v) isFarm2 = v end
})
FM_Add("Farm", Farm2Toggle)

local FarmDelayInput = MainTab:Input({
    Title = "Teleport Delay (Sec)",
    Value = tostring(farm2Delay),
    Flag = "FarmDelay_Cfg", -- [ADDED FLAG]
    Callback = function(v) 
        farm2Delay = tonumber(v) or 0.5 
    end
})
FM_Add("Farm", FarmDelayInput)


-- ==================== CATEGORY: LOCATIONS ====================
local LocDropdown = MainTab:Dropdown({
    Title = "Select Locations",
    Values = locationNumber,
    Multi = true,
    Value = {},
    Flag = "LocTarget_Cfg", -- [ADDED FLAG]
    Callback = function(selectedValues)
        table.clear(locationTargetList)
        if type(selectedValues) == "table" then
            for _, item in ipairs(selectedValues) do
                local name = type(item) == "table" and item.Title or item
                table.insert(locationTargetList, name)
            end
        end
    end
})
FM_Add("Locations", LocDropdown)

local AddLocBtn = MainTab:Button({
    Title = "Add Current Position",
    Icon = "plus",
    Callback = function()
        addLocationFunc()
        LocDropdown:Refresh(locationNumber)
        Notify("Location", "Position Added!", "map-pin")
    end
})
FM_Add("Locations", AddLocBtn)

local AutoTeleToggle = MainTab:Toggle({
    Title = "Auto Teleport Farm",
    Desc = "Loop through selected locations",
    Value = false,
    Flag = "AutoTeleLoc_Cfg", -- [ADDED FLAG]
    Callback = function(v)
        isTeleportFarm = v
        if v then task.spawn(autoTeleportFarmLoop) end
    end
})
FM_Add("Locations", AutoTeleToggle)

local LocSpeedInput = MainTab:Input({
    Title = "Location Delay",
    Value = "2",
    Flag = "LocDelay_Cfg", -- [ADDED FLAG]
    Callback = function(v) repeatTime = tonumber(v) or 2 end
})
FM_Add("Locations", LocSpeedInput)

local ClearLocBtn = MainTab:Button({
    Title = "Clear All Locations",
    Icon = "trash",
    Callback = function()
        table.clear(locationList)
        table.clear(locationNumber)
        LocDropdown:Refresh({})
        if writefile then
            writefile(LocationDB, "[]") -- Clear JSON
        end
        Notify("Location", "Cleared all data", "trash")
    end
})
FM_Add("Locations", ClearLocBtn)


-- ==================== CATEGORY: TELEPORT ====================
-- Populate map list dynamically
local MapList = {"None"}
task.spawn(function()
    local added = {}
    for _, boss in ipairs(bossList) do
        if not added[boss.map] then
            table.insert(MapList, boss.map)
            added[boss.map] = true
        end
    end
end)

local BackMapDropdown = MainTab:Dropdown({
    Title = "Auto Teleport Back Map",
    Desc = "Where to return after Boss/Dungeon",
    Values = MapList,
    Value = "None",
    Flag = "BackMap_Cfg", -- [ADDED FLAG]
    Callback = function(v)
        teleportBackMap = (type(v) == "table" and v.Title) or v
    end
})
FM_Add("Teleport", BackMapDropdown)

-- ==================== CATEGORY: BOSSES ====================
FM_Add("Bosses", MainTab:Paragraph({Title = "Info", Desc = "Turn ON before boss spawns!"}))

for i, boss in ipairs(bossList) do
    local tgl = MainTab:Toggle({
        Title = boss.map .. " - " .. boss.name,
        Value = false,
        Flag = "Boss_" .. boss.name .. "_Cfg", -- [ADDED FLAG]
        Callback = function(v)
            bossList[i].kill = v
        end
    })
    FM_Add("Bosses", tgl)
end

-- ==================== CATEGORY: TRIAL ====================
local TrialNames = {}
for _, t in ipairs(trialList) do table.insert(TrialNames, t.name) end

local TrialDD = MainTab:Dropdown({
    Title = "Trial Selection",
    Values = TrialNames,
    Multi = true,
    Flag = "TrialSelect_Cfg", -- [ADDED FLAG]
    Callback = function(vals)
        table.clear(targetTrial)
        if type(vals) == "table" then
            for _, v in ipairs(vals) do
                table.insert(targetTrial, (type(v)=="table" and v.Title) or v)
            end
        end
    end
})
FM_Add("Trial", TrialDD)

local WaveInput = MainTab:Input({
    Title = "Target Wave",
    Desc = "Leave after this wave",
    Value = "500",
    Flag = "WaveTarget_Cfg", -- [ADDED FLAG]
    Callback = function(v) targetWaveTrial = tonumber(v) or 500 end
})
FM_Add("Trial", WaveInput)

local AutoTrialToggle = MainTab:Toggle({
    Title = "Auto Farm Trial",
    Value = false,
    Flag = "AutoTrial_Cfg", -- [ADDED FLAG]
    Callback = function(v)
        isTrial = v
        if v then task.spawn(autoFarmDungeon) end
    end
})
FM_Add("Trial", AutoTrialToggle)

-- ==================== CATEGORY: POWERS ====================
for _, power in ipairs(powerList) do
    local ptgl = MainTab:Toggle({
        Title = "Auto " .. power.name,
        Value = false,
        Flag = "Power_"..power.name.."_Cfg", -- [ADDED FLAG]
        Callback = function(v)
            changePower(power.name, v)
        end
    })
    FM_Add("Powers", ptgl)
end

-- ==================== CATEGORY: STRONGER ====================
local RankToggle = MainTab:Toggle({
    Title = "Auto Rank Up",
    Value = false,
    Flag = "AutoRankUp_Cfg", -- [ADDED FLAG]
    Callback = function(v) isRankUp = v end
})
FM_Add("Stronger", RankToggle)

local ClaimExpToggle = MainTab:Toggle({
    Title = "Auto Claim Heroes Expedition",
    Value = false,
    Flag = "AutoClaimExp_Cfg", -- [ADDED FLAG]
    Callback = function(v) isAutoClaimExpedition = v end
})
FM_Add("Stronger", ClaimExpToggle)

local ExpMapList = {"None"}
task.spawn(function()
    local added = {}
    for _, boss in ipairs(bossList) do
        if not added[boss.map] then
            table.insert(ExpMapList, boss.map)
            added[boss.map] = true
        end
    end
end)

local ExpDropdown = MainTab:Dropdown({
    Title = "Expedition Map",
    Desc = "Auto Start Expedition",
    Values = ExpMapList,
    Value = "None",
    Flag = "ExpTarget_Cfg", -- [ADDED FLAG]
    Callback = function(v)
        expeditionTarget = (type(v) == "table" and v.Title) or v
    end
})
FM_Add("Stronger", ExpDropdown)

local HatchDropdown = MainTab:Dropdown({
    Title = "Auto Hatch (Star)",
    Desc = "Stay near star to open",
    Values = ExpMapList,
    Value = "None",
    Flag = "HatchTarget_Cfg", -- [ADDED FLAG]
    Callback = function(v)
        targetStar = (type(v) == "table" and v.Title) or v
    end
})
FM_Add("Stronger", HatchDropdown)

-- ==================== SETTINGS TAB (ADDED LIKE YUHU) ====================
local SettingsTab = Window:Tab({
    Title = "Settings",
    Icon = "settings-2"
});

local ConfigSection = SettingsTab:Section({
    Title = "Config Manager",
    Icon = "save",
    Opened = true
});

local ConfigName = "ANConfigAA";
SettingsTab:Input({
    Title = "Config Name",
    Placeholder = "ANConfigAA",
    Flag = "ConfigName_Input",
    Callback = function(txt)
        ConfigName = txt;
    end
});

SettingsTab:Button({
    Title = "Save Config",
    Icon = "save",
    Callback = function()
        -- Save ConfigManager (Flags)
        (Window.ConfigManager:CreateConfig(ConfigName)):Save();
        Window:Notify({Title = "Success", Content = "Saved!", Icon = "check"});
    end
});

SettingsTab:Button({
    Title = "Load Config",
    Icon = "upload",
    Callback = function()
        local cfg = Window.ConfigManager:GetConfig(ConfigName);
        if cfg then
            cfg:Load();
            -- Refresh Dynamic Lists manually if needed
            if LocDropdown then LocDropdown:Refresh(locationNumber) end
            Window:Notify({Title = "Success", Content = "Loaded!", Icon = "check"});
        end;
    end
});

SettingsTab:Button({
    Title = "Delete Config",
    Icon = "trash",
    Callback = function()
        Window.ConfigManager:DeleteConfig(ConfigName);
        Window:Notify({Title = "Success", Content = "Deleted!", Icon = "trash"});
    end
});

local FPSBtn = SettingsTab:Button({
    Title = "Reduce Lag / FPS Boost",
    Icon = "monitor",
    Callback = function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/khuyenbd8bb/RobloxKaitun/refs/heads/main/FPS%20Booster.lua"))()
        Notify("System", "FPS Boost Applied", "check")
    end
})

-- Initialize Category View
FM_OnChange("Farm")
Window:SelectTab(MainTab.Index);

-- ============================================================================
--  AUTO CONFIG LOADER (LIKE YUHU)
-- ============================================================================
task.spawn(function()
    task.wait(1.5);
    local DefaultConfig = "ANConfigAA";
    local CM = Window.ConfigManager;

    -- Folder Config sudah dibuat di atas
    
    pcall(function()
        if isfile(FolderPath .. "/Config/" .. DefaultConfig .. ".json") then
            local cfg = CM:GetConfig(DefaultConfig) or CM:CreateConfig(DefaultConfig);
            cfg:Load();
            
            -- Refresh UI yang datanya dinamis
            if LocDropdown then LocDropdown:Refresh(locationNumber) end
            
            l:Notify({
                Title = "Config",
                Content = "Restored " .. DefaultConfig,
                Icon = "check",
                Duration = 2
            });
        else
            CM:CreateConfig(DefaultConfig);
        end;
    end);

    -- Auto Save Loop
    while not Window.Destroyed do
        task.wait(10);
        pcall(function()
            local cfg = Window.ConfigManager:GetConfig(DefaultConfig);
            if cfg then
                cfg:Save();
            else
                (CM:CreateConfig(DefaultConfig)):Save();
            end;
        end);
    end;
end);
